<%- include('header') %>

    <h1 class="text-3xl font-bold text-gray-800 mb-8">Service Logs</h1>

    <!-- Bulk Upload -->
    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Bulk Upload Service Logs</h2>
        <div class="flex flex-col md:flex-row gap-4 items-center">
            <form action="/service-logs/upload" method="POST" enctype="multipart/form-data"
                class="flex flex-col sm:flex-row gap-4 items-center flex-1">
                <input type="file" name="file" accept=".xlsx, .xls" required
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded transition duration-300 whitespace-nowrap">Upload
                    Excel</button>
            </form>
            <a href="/service-logs/template"
                class="text-green-600 hover:text-green-800 font-semibold text-sm whitespace-nowrap">Download
                Template</a>
        </div>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-sm mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Log New Service</h2>
        <form action="/service-logs/add" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-group">
                    <label class="block text-gray-700 font-medium mb-2">Device</label>
                    <select name="deviceId" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                        <% devices.forEach(device=> { %>
                            <option value="<%= device.deviceId %>">
                                <%= device.name %> (<%= device.deviceId %>)
                            </option>
                            <% }) %>
                    </select>
                </div>
                <div class="form-group">
                    <label class="block text-gray-700 font-medium mb-2">Repair Type</label>
                    <select name="repairType" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                        <option value="Hardware">Hardware</option>
                        <option value="Software">Firmware</option>
                        <option value="Network">Network</option>
                        <option value="Battery">Battery</option>
                        <option value="Antenna">Antenna</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group md:col-span-2">
                    <label class="block text-gray-700 font-medium mb-2">Description</label>
                    <input type="text" name="description" placeholder="Issue description" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <div class="form-group">
                    <label class="block text-gray-700 font-medium mb-2">Start Date</label>
                    <input type="date" name="startDate" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                </div>
                <div class="form-group">
                    <label class="block text-gray-700 font-medium mb-2">End Date</label>
                    <input type="date" name="endDate" id="endDate"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                    <label class="flex items-center mt-2 text-sm text-gray-600">
                        <input type="checkbox" id="ongoingCheckbox" class="mr-2 rounded">
                        <span>Service is ongoing (no end date)</span>
                    </label>
                </div>
            </div>
            <button type="submit"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded transition duration-300">Save
                Service</button>
        </form>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-sm">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl font-semibold text-gray-800">Service History <span
                    class="text-gray-500 text-sm font-normal">(<%= totalCount %> total)</span></h2>

            <!-- Search Form -->
            <form action="/service-logs" method="GET" class="w-full md:w-auto">
                <div class="relative">
                    <input type="text" name="q" value="<%= search %>" placeholder="Search Device ID, Repair Type..."
                        class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition pl-10">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </form>
        </div>

        <div class="overflow-x-auto mb-6">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6">Date</th>
                        <th class="py-3 px-6">Device ID</th>
                        <th class="py-3 px-6">Repair Type</th>
                        <th class="py-3 px-6">Description</th>
                        <th class="py-3 px-6">Duration</th>
                        <th class="py-3 px-6">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light">
                    <% logs.forEach(log=> { %>
                        <tr class="border-b border-gray-200 hover:bg-gray-50">
                            <td class="py-3 px-6 whitespace-nowrap">
                                <%= log.startDate %>
                            </td>
                            <td class="py-3 px-6 font-medium">
                                <%= log.deviceId %>
                            </td>
                            <td class="py-3 px-6">
                                <span class="bg-blue-100 text-blue-600 py-1 px-3 rounded-full text-xs">
                                    <%= log.repairType || 'N/A' %>
                                </span>
                            </td>
                            <td class="py-3 px-6">
                                <%= log.description %>
                            </td>
                            <td class="py-3 px-6">
                                <%= log.startDate %> - <%= log.endDate || 'Ongoing' %>
                            </td>
                            <td class="py-3 px-6">
                                <div class="flex items-center space-x-2">
                                    <a href="/service-logs/edit/<%= log.id %>"
                                        class="text-yellow-500 hover:text-yellow-600 transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path
                                                d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </a>
                                    <button onclick="confirmDelete(<%= log.id %>)"
                                        class="text-red-500 hover:text-red-600 transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% }) %>
                            <% if (logs.length===0) { %>
                                <tr>
                                    <td colspan="6" class="py-6 text-center text-gray-500">No service logs found.</td>
                                </tr>
                                <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages> 1) { %>
            <div class="flex justify-center items-center space-x-2">
                <!-- Previous Button -->
                <% if (currentPage> 1) { %>
                    <a href="/service-logs?page=<%= currentPage - 1 %>&q=<%= search %>"
                        class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-gray-600">Previous</a>
                    <% } %>

                        <!-- First Page -->
                        <% if (currentPage> 3) { %>
                            <a href="/service-logs?page=1&q=<%= search %>"
                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-gray-600">1</a>
                            <% if (currentPage> 4) { %>
                                <span class="px-2 text-gray-400">...</span>
                                <% } %>
                                    <% } %>

                                        <!-- Pages around current -->
                                        <% const startPage=Math.max(1, currentPage - 2); const
                                            endPage=Math.min(totalPages, currentPage + 2); for(let i=startPage; i
                                            <=endPage; i++) { %>
                                            <a href="/service-logs?page=<%= i %>&q=<%= search %>"
                                                class="px-3 py-1 border <%= currentPage === i ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 hover:bg-gray-100 text-gray-600' %> rounded">
                                                <%= i %>
                                            </a>
                                            <% } %>

                                                <!-- Last Page -->
                                                <% if (currentPage < totalPages - 2) { %>
                                                    <% if (currentPage < totalPages - 3) { %>
                                                        <span class="px-2 text-gray-400">...</span>
                                                        <% } %>
                                                            <a href="/service-logs?page=<%= totalPages %>&q=<%= search %>"
                                                                class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-gray-600">
                                                                <%= totalPages %>
                                                            </a>
                                                            <% } %>

                                                                <!-- Next Button -->
                                                                <% if (currentPage < totalPages) { %>
                                                                    <a href="/service-logs?page=<%= currentPage + 1 %>&q=<%= search %>"
                                                                        class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 text-gray-600">Next</a>
                                                                    <% } %>

                                                                        <!-- Page Info -->
                                                                        <span class="ml-4 text-sm text-gray-600">Page
                                                                            <%= currentPage %> of <%= totalPages %>
                                                                                    </span>
            </div>
            <% } %>
    </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-1/3 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Delete Service Log</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to delete this service log? This action cannot be undone.
                    </p>
                </div>
                <div class="flex gap-3 px-4 py-3">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded transition duration-300">
                        Cancel
                    </button>
                    <button onclick="executeDelete()"
                        class="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded transition duration-300">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form for delete -->
    <form id="deleteForm" action="/service-logs/delete" method="POST" style="display: none;">
        <input type="hidden" name="id" id="deleteLogId">
    </form>

    <script>
        let logToDelete = null;

        function confirmDelete(logId) {
            logToDelete = logId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            logToDelete = null;
        }

        function executeDelete() {
            if (logToDelete) {
                document.getElementById('deleteLogId').value = logToDelete;
                document.getElementById('deleteForm').submit();
            }
        }

        // Close modal if clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('deleteModal');
            if (event.target == modal) {
                closeDeleteModal();
            }
        }

        $(document).ready(function () {
            // Initialize Select2
            $('select[name="deviceId"]').select2({
                placeholder: "Select a device",
                allowClear: true,
                width: '100%'
            });

            // Handle ongoing checkbox
            const ongoingCheckbox = document.getElementById('ongoingCheckbox');
            const endDateInput = document.getElementById('endDate');

            if (ongoingCheckbox && endDateInput) {
                ongoingCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        endDateInput.value = '';
                        endDateInput.disabled = true;
                        endDateInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                    } else {
                        endDateInput.disabled = false;
                        endDateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                });
            }
        });
    </script>

    <%- include('footer') %>