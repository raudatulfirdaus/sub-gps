<%- include('header') %>

    <h1 class="text-3xl font-bold text-gray-800 mb-8">Vendor Reconciliation</h1>

    <!-- Upload Vendor Invoice -->
    <div class="bg-white p-6 rounded-lg shadow-sm mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Upload Vendor Invoice</h2>
        <p class="text-gray-600 text-sm mb-4">Upload vendor Excel file with columns: <strong>MONTH</strong> and
            <strong>PLAT NO</strong> (Device ID). The system will match devices and identify billing discrepancies.</p>
        <form action="/report/upload-vendor" method="POST" enctype="multipart/form-data"
            class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-1">
                <label class="block text-gray-700 font-medium mb-2">Report Month</label>
                <input type="month" name="month" value="<%= reportMonth %>" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
            </div>
            <div class="flex-1">
                <label class="block text-gray-700 font-medium mb-2">Vendor Excel File</label>
                <input type="file" name="file" accept=".xlsx, .xls" required
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
            <button type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded transition duration-300 h-[42px]">Upload
                & Reconcile</button>
            <a href="/report/vendor-template"
                class="text-green-600 hover:text-green-800 font-semibold text-sm whitespace-nowrap">Download
                Template</a>
        </form>
    </div>

    <% if (hasVendorData) { %>
        <!-- Summary -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="text-gray-600 text-sm">Total Devices</div>
                <div class="text-3xl font-bold text-gray-800">
                    <%= summary.total %>
                </div>
            </div>
            <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                <div class="text-green-600 text-sm">Matched</div>
                <div class="text-3xl font-bold text-green-600">
                    <%= summary.matched %>
                </div>
            </div>
            <div class="bg-red-50 p-6 rounded-lg shadow-sm">
                <div class="text-red-600 text-sm">Disputes</div>
                <div class="text-3xl font-bold text-red-600">
                    <%= summary.disputes %>
                </div>
            </div>
            <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                <div class="text-yellow-600 text-sm">Missing</div>
                <div class="text-3xl font-bold text-yellow-600">
                    <%= summary.missing %>
                </div>
            </div>
            <div class="bg-blue-50 p-6 rounded-lg shadow-sm flex items-center justify-center">
                <a href="/report/reconcile/export?month=<%= reportMonth %>"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded transition duration-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                    Export
                </a>
            </div>
        </div>

        <!-- Reconciliation Table -->
        <div class="bg-white p-8 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Reconciliation Details</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6">Device ID</th>
                            <th class="py-3 px-6">Unit Name</th>
                            <th class="py-3 px-6">Division</th>
                            <th class="py-3 px-6">Vendor Status</th>
                            <th class="py-3 px-6">Internal Status</th>
                            <th class="py-3 px-6">Our Recommendation</th>
                            <th class="py-3 px-6">Discrepancy</th>
                            <th class="py-3 px-6">Reason</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-600 text-sm font-light">
                        <% reconciliation.forEach(item=> { %>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 font-medium">
                                    <%= item.deviceId %>
                                </td>
                                <td class="py-3 px-6">
                                    <%= item.device.name %>
                                </td>
                                <td class="py-3 px-6">
                                    <%= item.device.division %>
                                </td>
                                <td class="py-3 px-6">
                                    <span class="bg-blue-100 text-blue-600 py-1 px-3 rounded-full text-xs">
                                        <%= item.vendorStatus %>
                                    </span>
                                </td>
                                <td class="py-3 px-6">
                                    <span class="py-1 px-3 rounded-full text-xs
                                    <%= item.internalStatus === 'BILLABLE' ? 'bg-green-100 text-green-600' : '' %>
                                    <%= item.internalStatus === 'SERVICE' ? 'bg-purple-100 text-purple-600' : '' %>
                                    <%= item.internalStatus === 'EXPIRED' ? 'bg-red-100 text-red-600' : '' %>
                                    <%= item.internalStatus === 'PENDING' ? 'bg-yellow-100 text-yellow-600' : '' %>
                                    <%= item.internalStatus === 'NOT_IN_MASTER' ? 'bg-gray-100 text-gray-600' : '' %>
                                ">
                                        <%= item.internalStatus %>
                                    </span>
                                </td>
                                <td class="py-3 px-6">
                                    <span class="py-1 px-3 rounded-full text-xs font-semibold
                                    <%= item.ourRecommendation === 'BILLED' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>
                                ">
                                        <%= item.ourRecommendation %>
                                    </span>
                                </td>
                                <td class="py-3 px-6">
                                    <span class="py-1 px-3 rounded-full text-xs font-semibold
                                    <%= item.discrepancy === 'MATCH' ? 'bg-green-100 text-green-700' : '' %>
                                    <%= item.discrepancy === 'DISPUTE' ? 'bg-red-100 text-red-700' : '' %>
                                    <%= item.discrepancy === 'MISSING' ? 'bg-yellow-100 text-yellow-700' : '' %>
                                ">
                                        <%= item.discrepancy %>
                                    </span>
                                </td>
                                <td class="py-3 px-6 text-xs">
                                    <%= item.reason %>
                                </td>
                            </tr>
                            <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
        <% } else { %>
            <div class="bg-white p-12 rounded-lg shadow-sm text-center">
                <p class="text-gray-500 text-lg">No vendor data uploaded for this month. Please upload a vendor invoice
                    file to start reconciliation.</p>
            </div>
            <% } %>

                <%- include('footer') %>